require "thrift"
require_relative "service_handlers"
require_relative "./infrastructure/processor_factory"
require_relative "./infrastructure/logging_aspect"
require "aspector"

LoggingAspect = Azure::Storage::Infrastructure::LoggingAspect

multiplexed = Thrift::MultiplexedProcessor.new

multiplexed.register_processor(
  Azure::Storage::Constants::Service::SupportedFeatures,
  Azure::Storage::Infrastructure::ProcessorFactory.new(
    Azure::Storage::AutoGenerated::SupportedFeatures::Processor,
    Azure::Storage::Handler::SupportedFeatureHandler
  )
)
multiplexed.register_processor(
  Azure::Storage::Constants::Service::CloudQueueClient,
  Azure::Storage::Infrastructure::ProcessorFactory.new(
    Azure::Storage::AutoGenerated::CloudQueueClientService::Processor,
    Azure::Storage::Handler::CloudQueueClientHandler
  )
)
multiplexed.register_processor(
  Azure::Storage::Constants::Service::CloudQueue,
  Azure::Storage::Infrastructure::ProcessorFactory.new(
    Azure::Storage::AutoGenerated::CloudQueueService::Processor,
    Azure::Storage::Handler::CloudQueueHandler
  )
)
transport = Thrift::ServerSocket.new("0.0.0.0", 9993)

server = Thrift::ThreadedServer.new(multiplexed, transport, Thrift::FramedTransportFactory.new, Thrift::BinaryProtocolFactory.new)
LoggingAspect.apply(server)
server.serve()
